<!DOCTYPE HTML>
<body>
<style>
#results { border-collapse:collapse; }
#results_body {
  white-space:pre;
}
#results > thead > tr > td { padding:8px; }
#results_body > tr > td { padding:3px; }
#results_body > tr > td:not(.comment) { border:1px solid black; padding:3px; }
#results_body > tr { color:red; }
#results_body > .ok { color:green; }
#container {
  position:fixed;
  top:0;
  right:0;
}
</style>
<table id="results">
  <thead>
    <tr><td>Context<td>innerText<td>Expected content<td>Result
  </thead>
  <tbody id="results_body"></tbody>
</table>
<div id="container"></div>
<script>
function setupTest(context, plain) {
  container.innerHTML = context;
  var e = container.firstChild;
  while (e && e.nodeType != Node.ELEMENT_NODE) {
    e = e.nextSibling;
  }
  e.innerText = plain;
  return e;
}
function writeResults(context, plain, expected, t, msg) {
  var row = document.createElement('tr');
  var td1 = document.createElement('td');
  td1.textContent = context;
  var td2 = document.createElement('td');
  td2.textContent = plain;
  var td3 = document.createElement('td');
  td3.textContent = expected;
  var td4 = document.createElement('td');
  td4.textContent = t;
  var td5 = document.createElement('td');
  td5.textContent = msg;
  td5.classList.add("comment");
  row.appendChild(td1);
  row.appendChild(td2);
  row.appendChild(td3);
  row.appendChild(td4);
  row.appendChild(td5);
  if (t == expected) {
    row.classList.add("ok");
  }
  results_body.appendChild(row);
}
function testText(context, plain, expectedText, msg) {
  var e = setupTest(context, plain);
  var t;
  if (e.firstChild.nodeType != Node.TEXT_NODE) {
    t = "!!! Found non-text node";
  } else if (e.firstChild.nextSibling) {
    t = "!!! Found more than one node";
  } else {
    t = e.firstChild.data;
  }
  writeResults(context, plain, expectedText, t, msg);
}
function testHTML(context, plain, expectedHTML, msg) {
  var e = setupTest(context, plain);
  var t = e.innerHTML;
  writeResults(context, plain, expectedHTML, t, msg);
}

testText("<div>", "abc", "abc", "Simplest possible test");
testHTML("<div>", "abc\ndef", "abc<br>def", "Newlines convert to <br> in non-white-space:pre elements");
testHTML("<pre>", "abc\ndef", "abc<br>def", "Newlines convert to <br> in <pre> element");
testHTML("<div style='white-space:pre'>", "abc\ndef", "abc<br>def", "Newlines convert to <br> in white-space:pre element");
testHTML("<div>", "abc\rdef", "abc<br>def", "CRs convert to <br> in non-white-space:pre elements");
testHTML("<pre>", "abc\rdef", "abc<br>def", "CRs convert to <br> in <pre> element");
testHTML("<div>", "abc\r\ndef", "abc<br>def", "Newline/CR pair converts to <br> in non-white-space:pre element");
testHTML("<div>", "abc\n\ndef", "abc<br><br>def", "Newline/newline pair converts to two <br>s in non-white-space:pre element");
testHTML("<div>", "abc\r\rdef", "abc<br><br>def", "CR/CR pair converts to two <br>s in non-white-space:pre element");
testHTML("<div style='white-space:pre'>", "abc\rdef", "abc<br>def", "CRs convert to <br> in white-space:pre element");
testText("<div>", "abc<def", "abc<def", "< preserved");
testText("<div>", "abc>def", "abc>def", "> preserved");
testText("<div>", "abc&", "abc&", "& preserved");
testText("<div>", "abc\"def", "abc\"def", "\" preserved");
testText("<div>", "abc\'def", "abc\'def", "\' preserved");

// Fails in Edge 20.10240.16384.0. Looks like the null character is treated as a terminator;
// "def" is just chopped off.
testText("<div>", "abc\0def", "abc\0def", "Null characters preserved");

// Fails in Edge 20.10240.16384.0: Tab converted to &nbsp;.
testText("<div>", "abc\tdef", "abc\tdef", "Tabs preserved");

// Fails in Edge 20.10240.16384.0: Leading whitespace converted to &nbsp;.
testText("<div>", " abc", " abc", "Leading whitespace preserved");

testText("<div>", "abc ", "abc ", "Trailing whitespace preserved");

// Fails in Edge 20.10240.16384.0: First whitespace character converted to &nbsp;.
testText("<div>", "abc  def", "abc  def", "Whitespace not compressed");

testHTML("<div>abc\n\n", "abc", "abc", "Existing text deleted");
testHTML("<div><br>", "abc", "abc", "Existing <br> deleted");

</script>
